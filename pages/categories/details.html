<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail View</title>

    <!-- Global CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/navbar.css">
    <link rel="stylesheet" href="/assets/css/footer.css">

</head>

<body>

<div id="navbar-container"></div>

<div class="detail-container">
    <div class="detail-header">
        <img id="detail-image" src="" alt="Cover">
        <div class="detail-info">
            <h2 id="detail-title"></h2>
            <p id="detail-desc"></p>

            <div id="detail-extra" class="detail-extra"></div>

        </div>
    </div>
</div>

<div id="footer-container"></div>

<script src="/assets/js/app.js"></script>
<script>
    /* Load navbar & footer */
    fetch("/components/navbar.html").then(r => r.text()).then(html => {
        document.getElementById("navbar-container").innerHTML = html;
        if (window.setupNavbarInteractions) window.setupNavbarInteractions();
    });
    fetch("/components/footer.html").then(r => r.text()).then(html => {
        document.getElementById("footer-container").innerHTML = html;
    });

    /* Read parameters */
    const params = new URLSearchParams(window.location.search);
    const category = params.get("type") || params.get("category");
    const id = params.get("id");

    /* Validate */
    if (!category || !id) {
        document.querySelector(".detail-container").innerHTML = "<p>No item selected.</p>";
    } else {
        loadFromSession();
    }

    function loadFromSession() {
        const key = `media:${category}:${id}`;
        let item = null;
        try {
            item = JSON.parse(sessionStorage.getItem(key));
        } catch (err) {
            item = null;
        }

        if (!item) {
            document.querySelector(".detail-container").innerHTML = "<p>Details unavailable. Open this page from Home or My List.</p>";
            return;
        }

        renderDetail(item);
    }

    function renderDetail(item) {
        const image = item.image || "/assets/default_poster.jpg";
        document.getElementById("detail-image").src = image;
        document.getElementById("detail-title").textContent = item.title || item.name || "Untitled";
        document.getElementById("detail-desc").textContent = item.description || "No description available yet.";

        const extra = document.getElementById("detail-extra");
        const typeLabel = formatType(item._type || category);
        const extraRows = buildMetaRows(item, typeLabel);
        extra.innerHTML = extraRows.length ? extraRows.join("") : "<p>No extra details available.</p>";
    }

    function buildMetaRows(item, typeLabel) {
        const rows = [
            { label: "Type", value: typeLabel },
            { label: "Score", value: item.score },
            { label: "Release Date", value: formatDate(item.release_date) },
            { label: "First Air Date", value: formatDate(item.first_air_date) },
            { label: "Released", value: formatDate(item.released) },
            { label: "Start Date", value: formatDate(item.start_date) },
            { label: "End Date", value: formatDate(item.end_date) },
            { label: "Year", value: item.year },
            { label: "Status", value: item.status },
            { label: "Media Type", value: item.media_type },
            { label: "Episodes", value: item.episodes },
            { label: "Chapters", value: item.chapters },
            { label: "Volumes", value: item.volumes },
            { label: "Rating", value: item.rating },
            { label: "Members", value: item.members },
            { label: "Metacritic", value: item.metacritic },
            { label: "Popularity", value: item.popularity },
            { label: "Vote Count", value: item.vote_count },
            { label: "Ratings Count", value: item.ratings_count },
            { label: "Original Language", value: item.original_language },
            { label: "Genres", value: formatList(item.genres) },
            { label: "Platforms", value: formatList(item.platforms) },
            { label: "Added", value: formatDate(item.added_at) },
            { label: "Progress", value: item.progress }
        ];

        return rows
            .filter(row => isValuePresent(row.value))
            .map(row => `<p><strong>${row.label}:</strong> ${row.value}</p>`);
    }

    function formatDate(value) {
        if (!value) return null;
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleDateString();
    }

    function formatList(values) {
        if (!Array.isArray(values) || values.length === 0) return null;
        return values.join(", ");
    }

    function isValuePresent(value) {
        if (value === null || value === undefined) return false;
        if (typeof value === "string") return value.trim().length > 0;
        if (Array.isArray(value)) return value.length > 0;
        return true;
    }

    function formatType(rawType) {
        const map = {
            movies: "Movie",
            movie: "Movie",
            series: "Series",
            animes: "Anime",
            anime: "Anime",
            manga: "Manga",
            novels: "Novel",
            novel: "Novel",
            games: "Game",
            game: "Game"
        };

        return map[rawType] || rawType;
    }
</script>

</body>
</html>
