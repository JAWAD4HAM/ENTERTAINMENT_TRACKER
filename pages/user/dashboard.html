<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - Entertainment Tracker</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/navbar.css">
  <link rel="stylesheet" href="/assets/css/footer.css">

  <style>
    .dashboard-container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 40px;
    }

    .chart-card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 300px;
      color: #333;
    }

    .list-section {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f8f9fa;
    }

    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }

    .btn-delete {
      background-color: #ff4d4d;
      color: white;
    }

    .btn-save {
      background-color: #4CAF50;
      color: white;
    }
  </style>
</head>

<body>

  <div id="navbar-container"></div>

  <div class="dashboard-container">
    <h1 style="color:white; margin-bottom: 20px;">My Dashboard</h1>

    <!-- Stats -->
    <div class="stats-row">
      <div class="chart-card">
        <h3>Library Composition</h3>
        <canvas id="typeChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Status Breakdown</h3>
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <!-- List Management -->
    <div class="list-section">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>My List Management</h2>
        <select id="filterType" onchange="renderListTable()">
          <option value="all">All Types</option>
          <option value="movies">Movies</option>
          <option value="series">Series</option>
          <option value="animes">Animes</option>
          <option value="manga">Manga</option>
          <option value="novels">Novels</option>
          <option value="games">Games</option>
        </select>
      </div>
      <div style="overflow-x:auto;">
        <table id="listTable">
          <thead>
            <tr>
              <th>Image</th>
              <th>Title</th>
              <th>Type</th>
              <th>Status</th>
              <th>Score</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Items rendered here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    let fullList = {}; // To store fetched data

    if (!token) window.location.href = '../auth/login.html';

    // Load Components
    fetch("/components/navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar-container").innerHTML = html;
        setupNavbarInteractions();
      });
    fetch("/components/footer.html")
      .then(res => res.text())
      .then(html => document.getElementById("footer-container").innerHTML = html);

    // Navbar Interaction (Logout + Search Redirect)
    function setupNavbarInteractions() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '../auth/login.html';
        });
      }
      // Bind search function for Dashboard (Redirect to home)
      window.searchMedia = function () {
        const type = document.getElementById('navSearchType').value;
        const query = document.getElementById('navSearchQuery').value;
        if (query) {
          window.location.href = `../home.html?search_type=${type}&search_query=${encodeURIComponent(query)}`;
        }
      };
    }

    // Load Data
    async function loadData() {
      try {
        const res = await fetch(`${API_BASE}/list`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        fullList = data;

        renderCharts(data);
        renderListTable();
      } catch (e) {
        console.error("Error loading data", e);
      }
    }

    // Charts
    let typeChartInstance = null;
    let statusChartInstance = null;

    function renderCharts(data) {
      // Prepare Data
      const typeCounts = {};
      const statusCounts = {};

      Object.keys(data).forEach(type => {
        // exclude favorites/progress keys if they exist, but user.json structure is structured by type mostly
        if (!Array.isArray(data[type]) && typeof data[type] === 'object') {
          // It's a category like "animes": { "watching": [], ... }
          let typeCount = 0;
          Object.keys(data[type]).forEach(status => {
            const count = data[type][status].length;
            typeCount += count;

            statusCounts[status] = (statusCounts[status] || 0) + count;
          });
          if (typeCount > 0) typeCounts[type] = typeCount;
        }
      });

      // Type Chart (Pie)
      const ctxType = document.getElementById('typeChart').getContext('2d');
      if (typeChartInstance) typeChartInstance.destroy();
      typeChartInstance = new Chart(ctxType, {
        type: 'pie',
        data: {
          labels: Object.keys(typeCounts).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
          datasets: [{
            data: Object.values(typeCounts),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
          }]
        }
      });

      // Status Chart (Bar)
      const ctxStatus = document.getElementById('statusChart').getContext('2d');
      if (statusChartInstance) statusChartInstance.destroy();
      statusChartInstance = new Chart(ctxStatus, {
        type: 'bar',
        data: {
          labels: Object.keys(statusCounts).map(s => s.replace(/_/g, ' ')),
          datasets: [{
            label: 'Items by Status',
            data: Object.values(statusCounts),
            backgroundColor: '#36A2EB'
          }]
        }
      });
    }

    // List Table
    function renderListTable() {
      const filter = document.getElementById('filterType').value;
      const tbody = document.querySelector('#listTable tbody');
      tbody.innerHTML = '';

      Object.keys(fullList).forEach(type => {
        if (filter !== 'all' && type !== filter) return;

        if (typeof fullList[type] === 'object') {
          Object.keys(fullList[type]).forEach(status => {
            fullList[type][status].forEach(item => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                                <td><img src="${item.image || '/assets/default_poster.jpg'}" style="width:40px;height:60px;object-fit:cover;"></td>
                                <td>${item.title}</td>
                                <td>${type}</td>
                                <td>
                                    <select id="status-${type}-${item.id}">
                                        <option value="plan_to_watch" ${status.includes('plan') ? 'selected' : ''}>Plan to Watch/Read/Play</option>
                                        <option value="watching" ${status === 'watching' || status === 'reading' || status === 'playing' ? 'selected' : ''}>Watching/Reading/Playing</option>
                                        <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="on_hold" ${status === 'on_hold' ? 'selected' : ''}>On Hold</option>
                                        <option value="dropped" ${status === 'dropped' ? 'selected' : ''}>Dropped</option>
                                    </select>
                                </td>
                                <td><input type="number" id="score-${type}-${item.id}" value="${item.score || 0}" min="0" max="10" style="width:50px;"></td>
                                <td>
                                    <button class="action-btn btn-save" onclick="updateItem('${type}', '${item.id}')"><i class="fa fa-save"></i></button>
                                    <button class="action-btn btn-delete" onclick="deleteItem('${type}', '${item.id}')"><i class="fa fa-trash"></i></button>
                                </td>
                            `;
              tbody.appendChild(tr);
            });
          });
        }
      });
    }

    // Actions
    async function updateItem(type, id) {
      const status = document.getElementById(`status-${type}-${id}`).value;
      const score = document.getElementById(`score-${type}-${id}`).value;

      // Mapping simple status to category specific if needed
      // Backend handles generic 'watching' -> 'reading' for manga? user.json structure has distinct arrays?
      // Actually user.json has 'watching', 'completed', 'plan_to_watch' etc for Anime.
      // For Manga it has 'reading', 'completed', 'plan_to_read'.
      // The dropdown needs to be smart or the backend list.js needs to handle mapping.
      // Let's rely on backend list.js:
      /*
          // list.js PUT /:type/:id
          // It just updates the item in the list. It blindly moves it.
          // WE NEED TO SEND THE CORRECT STATUS STRING.
      */
      let finalStatus = status;
      if (['manga', 'novels'].includes(type)) {
        if (status === 'watching') finalStatus = 'reading';
        if (status === 'plan_to_watch') finalStatus = 'plan_to_read';
      } else if (type === 'games') {
        if (status === 'watching') finalStatus = 'playing';
        if (status === 'plan_to_watch') finalStatus = 'plan_to_play';
      }

      try {
        const res = await fetch(`${API_BASE}/list/${type}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ status: finalStatus, score: score })
        });
        if (res.ok) {
          alert('Updated!');
          loadData();
        } else {
          alert('Update failed');
        }
      } catch (e) { console.error(e); }
    }

    async function deleteItem(type, id) {
      if (!confirm("Are you sure?")) return;
      try {
        const res = await fetch(`${API_BASE}/list/${type}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` },
        });
        if (res.ok) {
          loadData();
        } else {
          alert('Delete failed');
        }
      } catch (e) { console.error(e); }
    }

    // Init
    loadData();

  </script>
</body>

</html>